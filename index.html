<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>團購小幫手</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0f766e" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/npm/lucide-static@0.344.0/icons/shopping-bag.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#0f766e', secondary: '#f59e0b', danger: '#ef4444' } } }
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 text-gray-900 antialiased overscroll-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const { Plus, Trash2, ChevronRight, ArrowLeft, Printer, CheckCircle, Circle, Edit2, Users, Receipt, Search, X, Save } = lucide;

        // --- Hooks ---
        function useLocalStorage(key, initialValue) {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    return initialValue;
                }
            });
            const setValue = (value) => {
                const valueToStore = value instanceof Function ? value(storedValue) : value;
                setStoredValue(valueToStore);
                window.localStorage.setItem(key, JSON.stringify(valueToStore));
            };
            return [storedValue, setValue];
        }

        // --- Components ---
        const Button = ({ children, variant = 'primary', size = 'md', className = '', icon, ...props }) => {
            const baseStyle = "inline-flex items-center justify-center rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none";
            const variants = {
                primary: "bg-primary text-white hover:bg-teal-800 focus:ring-teal-500",
                secondary: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 focus:ring-gray-500",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 focus:ring-red-500 border border-transparent",
                ghost: "bg-transparent text-gray-600 hover:bg-gray-100 hover:text-gray-900",
            };
            const sizes = { sm: "h-8 px-3 text-xs", md: "h-10 px-4 py-2 text-sm", lg: "h-12 px-6 text-base" };
            return (
                <button className={`${baseStyle} ${variants[variant]} ${sizes[size]} ${className}`} {...props}>
                    {icon && <span className="mr-2">{icon}</span>}
                    {children}
                </button>
            );
        };

        const OrderFormModal = ({ isOpen, onClose, onSubmit, initialData }) => {
            const [buyerName, setBuyerName] = useState('');
            const [itemName, setItemName] = useState('');
            const [price, setPrice] = useState('');
            const [quantity, setQuantity] = useState('1');
            const [isPaid, setIsPaid] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    if (initialData) {
                        setBuyerName(initialData.buyerName);
                        setItemName(initialData.itemName);
                        setPrice(initialData.price.toString());
                        setQuantity(initialData.quantity.toString());
                        setIsPaid(initialData.isPaid);
                    } else {
                        setBuyerName(''); setItemName(''); setPrice(''); setQuantity('1'); setIsPaid(false);
                    }
                }
            }, [isOpen, initialData]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm no-print">
                    <div className="w-full max-w-md bg-white rounded-t-2xl sm:rounded-2xl shadow-xl p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-gray-800">{initialData ? '編輯項目' : '新增項目'}</h2>
                            <button onClick={onClose} className="text-gray-400"><X size={24} /></button>
                        </div>
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            onSubmit({ buyerName, itemName, price: parseFloat(price), quantity: parseInt(quantity), isPaid });
                            onClose();
                        }} className="space-y-4">
                            <div className="space-y-1">
                                <label className="text-xs text-gray-500 font-bold">姓名 (誰買的)</label>
                                <input type="text" required value={buyerName} onChange={(e) => setBuyerName(e.target.value)} placeholder="例如: 徐小明" className="w-full rounded-lg border border-gray-300 p-3" />
                            </div>
                            <div className="space-y-1">
                                <label className="text-xs text-gray-500 font-bold">品項</label>
                                <input type="text" required value={itemName} onChange={(e) => setItemName(e.target.value)} placeholder="例如: 雙面膠" className="w-full rounded-lg border border-gray-300 p-3" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-1">
                                    <label className="text-xs text-gray-500 font-bold">單價</label>
                                    <input type="number" required value={price} onChange={(e) => setPrice(e.target.value)} placeholder="0" className="w-full rounded-lg border border-gray-300 p-3" />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-xs text-gray-500 font-bold">數量</label>
                                    <input type="number" required value={quantity} onChange={(e) => setQuantity(e.target.value)} placeholder="1" className="w-full rounded-lg border border-gray-300 p-3 text-center" />
                                </div>
                            </div>
                            <div className="flex items-center space-x-3 py-2"><input type="checkbox" id="isPaid" checked={isPaid} onChange={(e) => setIsPaid(e.target.checked)} className="w-5 h-5 text-primary" /><label htmlFor="isPaid" className="font-bold text-gray-700">已經付款?</label></div>
                            <Button type="submit" className="w-full" size="lg">{initialData ? '儲存修改' : '加入清單'}</Button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        function App() {
            const [groupBuys, setGroupBuys] = useLocalStorage('groupbuys_v1', []);
            const [view, setView] = useState('LIST');
            const [activeId, setActiveId] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingOrder, setEditingOrder] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');

            const activeGroupBuy = useMemo(() => groupBuys.find(g => g.id === activeId), [groupBuys, activeId]);
            const filteredOrders = useMemo(() => {
                if (!activeGroupBuy) return [];
                const query = searchQuery.toLowerCase();
                return activeGroupBuy.orders.filter(o => o.buyerName.toLowerCase().includes(query) || o.itemName.toLowerCase().includes(query));
            }, [activeGroupBuy, searchQuery]);

            const calculateTotal = (orders) => orders.reduce((acc, curr) => acc + (curr.price * curr.quantity), 0);

            if (view === 'LIST') {
                return (
                    <div className="min-h-screen max-w-2xl mx-auto bg-gray-50 flex flex-col shadow-xl">
                        <header className="bg-primary text-white p-6 sticky top-0 z-10 shadow-md">
                            <div className="flex justify-between items-center">
                                <h1 className="text-2xl font-bold flex items-center gap-2"><Users size={24} /> 團購小幫手</h1>
                                <button onClick={() => {
                                    const title = prompt("輸入團購名稱");
                                    if (title) setGroupBuys([{ id: Date.now().toString(), title, createdAt: Date.now(), orders: [] }, ...groupBuys]);
                                }} className="bg-white/20 p-2 rounded-full"><Plus size={24} /></button>
                            </div>
                        </header>
                        <main className="p-4 space-y-3 flex-1">
                            {groupBuys.length === 0 ? (
                                <div className="text-center py-20 text-gray-400">
                                    <Receipt size={64} className="mx-auto mb-4 opacity-20" />
                                    <p>目前沒有團購單</p>
                                    <Button onClick={() => {
                                        const title = prompt("輸入團購名稱");
                                        if (title) setGroupBuys([{ id: Date.now().toString(), title, createdAt: Date.now(), orders: [] }, ...groupBuys]);
                                    }} className="mt-4">建立第一張單</Button>
                                </div>
                            ) : groupBuys.map(g => (
                                <div key={g.id} onClick={() => { setActiveId(g.id); setView('DETAIL'); }} className="p-4 bg-white border border-gray-100 rounded-xl shadow-sm flex justify-between items-center cursor-pointer hover:shadow-md transition-all">
                                    <div><h3 className="font-bold text-lg">{g.title}</h3><p className="text-sm text-gray-500">{g.orders.length} 筆訂單</p></div>
                                    <div className="flex items-center gap-3">
                                        <span className="font-bold text-primary bg-teal-50 px-3 py-1 rounded-full text-sm">${calculateTotal(g.orders).toLocaleString()}</span>
                                        <button onClick={(e) => { e.stopPropagation(); if(confirm("確定刪除此團購單？")) setGroupBuys(groupBuys.filter(x => x.id !== g.id)); }} className="text-gray-300 hover:text-red-500 p-2"><Trash2 size={18} /></button>
                                        <ChevronRight size={20} className="text-gray-300" />
                                    </div>
                                </div>
                            ))}
                        </main>
                    </div>
                );
            }

            if (!activeGroupBuy) return null;
            const total = calculateTotal(activeGroupBuy.orders);
            const collected = activeGroupBuy.orders.reduce((acc, o) => o.isPaid ? acc + (o.price * o.quantity) : acc, 0);
            const progress = total > 0 ? (collected / total) * 100 : 0;

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col">
                    <header className="bg-white border-b sticky top-0 z-20 no-print">
                        <div className="p-4 flex items-center justify-between">
                            <div className="flex items-center gap-2 overflow-hidden">
                                <button onClick={() => setView('LIST')} className="p-2 hover:bg-gray-100 rounded-full"><ArrowLeft size={24} /></button>
                                <div className="overflow-hidden"><h1 className="font-bold text-lg truncate">{activeGroupBuy.title}</h1><p className="text-xs text-gray-500">總計 ${total.toLocaleString()}</p></div>
                            </div>
                            <button onClick={() => window.print()} className="p-2 text-gray-600"><Printer size={20} /></button>
                        </div>
                        <div className="px-4 pb-3">
                            <div className="flex justify-between text-xs font-bold mb-1 text-teal-600"><span>收款進度</span><span>{Math.round(progress)}% ({collected}/{total})</span></div>
                            <div className="h-2 bg-teal-100 rounded-full overflow-hidden"><div style={{width: `${progress}%`}} className="h-full bg-teal-500 transition-all duration-500"></div></div>
                            <div className="relative mt-3">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={16} />
                                <input type="text" placeholder="搜尋姓名或品項..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-gray-100 rounded-lg outline-none text-sm focus:ring-2 focus:ring-primary/20" />
                            </div>
                        </div>
                    </header>
                    <main className="p-4 flex-1 pb-24 max-w-4xl mx-auto w-full">
                        <div className="space-y-3">
                            {filteredOrders.map(o => (
                                <div key={o.id} className={`p-4 bg-white rounded-xl shadow-sm border-l-4 ${o.isPaid ? 'border-teal-500' : 'border-amber-400'} flex justify-between items-center transition-all`}>
                                    <div className="flex-1" onClick={() => { setEditingOrder(o); setIsModalOpen(true); }}>
                                        <div className="flex justify-between font-bold text-gray-900 mb-1"><span>{o.buyerName}</span><span>${(o.price * o.quantity).toLocaleString()}</span></div>
                                        <div className="text-sm text-gray-500">{o.itemName} x{o.quantity} <span className="text-xs">(@{o.price})</span></div>
                                    </div>
                                    <div className="ml-4 flex flex-col items-end gap-3">
                                        <button onClick={() => setGroupBuys(groupBuys.map(g => g.id === activeId ? { ...g, orders: g.orders.map(x => x.id === o.id ? { ...x, isPaid: !x.isPaid } : x) } : g))} className={`p-1 rounded-full ${o.isPaid ? 'text-teal-500' : 'text-gray-300'}`}>
                                            {o.isPaid ? <CheckCircle size={28} className="fill-current" /> : <Circle size={28} />}
                                        </button>
                                        <button onClick={() => { if(confirm("刪除這筆資料？")) setGroupBuys(groupBuys.map(g => g.id === activeId ? { ...g, orders: g.orders.filter(x => x.id !== o.id) } : g)); }} className="text-gray-300 hover:text-red-500"><Trash2 size={16} /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>
                    <button onClick={() => { setEditingOrder(null); setIsModalOpen(true); }} className="fixed bottom-6 right-6 bg-secondary text-white p-4 rounded-full shadow-lg no-print hover:scale-110 active:scale-95 transition-all"><Plus size={28} /></button>
                    <OrderFormModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} initialData={editingOrder} onSubmit={(data) => {
                        setGroupBuys(groupBuys.map(g => {
                            if (g.id !== activeId) return g;
                            if (editingOrder) return { ...g, orders: g.orders.map(x => x.id === editingOrder.id ? { ...x, ...data } : x) };
                            return { ...g, orders: [{ ...data, id: Date.now().toString(), createdAt: Date.now() }, ...g.orders] };
                        }));
                    }} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>